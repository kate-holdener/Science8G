<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="./style.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matching Quiz Practice</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="quiz_data.js"></script>
    <style>
        .fill-in-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .fill-in-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .fill-in-item.correct {
            border-color: #4CAF50;
            background: #f1f8f4;
        }
        .fill-in-item.incorrect {
            border-color: #f44336;
            background: #fef1f0;
        }
        .fill-in-definition {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
            line-height: 1.5;
        }
        .fill-in-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .fill-in-input {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
        }
        .fill-in-input:focus {
            outline: none;
            border-color: #2196F3;
        }
        .fill-in-input.correct {
            border-color: #4CAF50;
            background: #f1f8f4;
        }
        .fill-in-input.incorrect {
            border-color: #f44336;
            background: #fef1f0;
        }
        .fill-in-feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .fill-in-feedback.correct {
            color: #4CAF50;
            background: #f1f8f4;
        }
        .fill-in-feedback.incorrect {
            color: #f44336;
            background: #fef1f0;
        }
        .fill-in-number {
            display: inline-block;
            background: #2196F3;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>8th Grade Science Vocabulary Quiz Practice!</h1>
            <div class="stats">
                <div class="stat">
                    <div>Page: <span id="currentPage">1</span> of <span id="totalPages">1</span></div>
                </div>
                <div class="stat">
                    <div>Score: <span id="correctCount">0</span> / <span id="totalAttempts">0</span></div>
                </div>
                <div class="stat">
                    <div>Accuracy: <span id="accuracy">0%</span></div>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="quiz-selector">
                <label for="quizSet">Choose Quiz Set:</label>
                <select id="quizSet">
                    <option value="">Select a quiz set...</option>
                </select>
                <button class="btn btn-secondary" onclick="resetQuiz()">Reset</button>
            </div>
            <div class="controls" id="quizTypeControls" style="display: none;">
                <button class="btn btn-primary" onclick="showInteractiveQuizControls(true)">Matching Quiz</button>
                <button class="btn btn-primary" onclick="showFillInControls(true)">Fill-in Quiz</button>
                <button class="btn btn-secondary" onclick="openPaperQuiz()">Paper Quiz</button>
            </div>
            <div class="controls" id="quizControls" style="display: none;">
                <label for="itemsPerPage">Items per page:</label>
                <input type="number" id="itemsPerPage" value="10" min="5" max="20">
                <button class="btn btn-primary" onclick="startQuiz()">Start Matching Quiz</button>
            </div>
            <div class="controls" id="fillInControls" style="display: none;">
                <label for="fillInItemsPerPage">Items per page:</label>
                <input type="number" id="fillInItemsPerPage" value="10" min="5" max="20">
                <button class="btn btn-primary" onclick="startFillInQuiz()">Start Fill-in Quiz</button>
            </div>

            <!-- MATCHING QUIZ AREA -->
            <div id="quizArea" class="quiz-area">
                <div class="page-info">
                    <span id="pageInfo">Page 1 of 1</span>
                </div>

                <div class="matching-container">
                    <div class="terms-column">
                        <div class="column-title">ðŸ“š Terms</div>
                        <div id="termsContainer"></div>
                    </div>
                    <div class="definitions-column">
                        <div class="column-title">ðŸ“– Definitions</div>
                        <div id="definitionsContainer"></div>
                    </div>
                </div>

                <div class="quiz-actions">
                    <button class="btn btn-secondary" onclick="clearMatches()">Clear All</button>
                    <button class="btn btn-warning" onclick="checkAnswers()" id="checkAnswers" disabled>Check Answers</button>
                    <button class="btn btn-primary" onclick="nextPage()" id="nextBtn" style="display: none;" disabled>Next Page</button>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 10px; text-align: center;">
                    <p><strong>ðŸ’¡ How to use:</strong></p>
                    <p>â€¢ Click on a term to select it (it will turn blue)</p>
                    <p>â€¢ Then click on the matching definition</p>
                    <p>â€¢ Click the Ã— button to disconnect a match</p>
                    <p>â€¢ Check your answers when ready!</p>
                    <p>â€¢ <em>Note: Each term may have multiple possible definitions - any correct match is accepted!</em></p>
                </div>

                <div id="results" class="results"></div>
            </div>

            <!-- FILL-IN QUIZ AREA -->
            <div id="fillInArea" class="quiz-area" style="display: none;">
                <div class="page-info">
                    <span id="fillInPageInfo">Page 1 of 1</span>
                </div>

                <div class="fill-in-container" id="fillInContainer"></div>

                <div class="quiz-actions">
                    <button class="btn btn-secondary" onclick="clearFillInAnswers()">Clear All</button>
                    <button class="btn btn-warning" onclick="checkFillInAnswers()" id="checkFillInAnswers">Check Answers</button>
                    <button class="btn btn-primary" onclick="nextFillInPage()" id="nextFillInBtn" style="display: none;" disabled>Next Page</button>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 10px; text-align: center;">
                    <p><strong>ðŸ’¡ How to use:</strong></p>
                    <p>â€¢ Read each definition carefully</p>
                    <p>â€¢ Type the correct term in the input box</p>
                    <p>â€¢ Spelling must be exact (not case-sensitive)</p>
                    <p>â€¢ Click "Check Answers" when ready!</p>
                </div>

                <div id="fillInResults" class="results"></div>
            </div>
        </div>            
    </div>

    <script>
        // Quiz data - now supports multiple definitions per term

        let currentQuizData = [];
        let currentPageData = [];
        let shuffledPageData = [];
        let currentPage = 0;
        let totalPages = 1;
        let itemsPerPage = 10;
        let matches = {};
        let selectedTerm = null;
        let checkedAnswers = false;
        let correctCount = 0;
        let totalAttempts = 0;
        let firstTryCorrect = new Set();
        let answerStates = {};
        let currentDefinitionChoices = {};

        // Fill-in quiz variables
        let fillInQuizData = [];
        let fillInPageData = [];
        let fillInCurrentPage = 0;
        let fillInTotalPages = 1;
        let fillInItemsPerPage = 10;
        let fillInAnswers = {};
        let fillInChecked = false;
        let fillInCorrectCount = 0;
        let fillInTotalAttempts = 0;
        let fillInFirstTryCorrect = new Set();

        // Initialize the app
        function initializeApp() {
            populateQuizSelector();
            updateStats();
        }

        function populateQuizSelector() {
            const select = document.getElementById('quizSet');
            select.innerHTML = '<option value="">Select a quiz set...</option>';
            
            Object.keys(quizSets).forEach(setName => {
                const option = document.createElement('option');
                option.value = setName;
                option.textContent = `${setName} (${quizSets[setName].length} items)`;
                select.appendChild(option);
            });

            select.addEventListener('change', function() {
                const quizTypeControls = document.getElementById('quizTypeControls');
                if (this.value) {
                    quizTypeControls.style.display = 'block';
                } else {
                    quizTypeControls.style.display = 'none';
                }
            });
        }

        // MATCHING QUIZ FUNCTIONS
        function startQuiz() {
            const selectedSet = document.getElementById('quizSet').value;
            if (!selectedSet) {
                alert('Please select a quiz set first!');
                return;
            }
            document.getElementById('quizControls').style.display = 'none';
            document.getElementById('quizTypeControls').style.display = 'none';
            document.getElementById('fillInArea').style.display = 'none';
            document.getElementById('quizArea').classList.add('active');

            const rawData = quizSets[selectedSet];
            currentQuizData = shuffleArray(rawData.map(item => ({
                term: item.term,
                def: getRandomDefinition(item.defs),
                allDefs: item.defs
            })));

            itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
            totalPages = Math.ceil(currentQuizData.length / itemsPerPage);
            currentPage = 1;
            matches = {};
            selectedTerm = null;
            checkedAnswers = false;
            correctCount = 0;
            totalAttempts = 0;
            firstTryCorrect = new Set();
            answerStates = {};
            currentDefinitionChoices = {};

            document.getElementById('quizArea').classList.add('active');
            loadCurrentPage();
            updateStats();
            updatePageControls();
        }

        function getRandomDefinition(definitions) {
            return definitions[Math.floor(Math.random() * definitions.length)];
        }

        function loadCurrentPage() {
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            currentPageData = currentQuizData.slice(startIdx, endIdx);

            currentPageData = currentPageData.map((item, index) => ({
                ...item,
                def: getRandomDefinition(item.allDefs)
            }));

            shuffledPageData = currentPageData.map((item, originalIndex) => ({
                def: item.def,
                correctTerm: item.term,
                allCorrectDefs: item.allDefs,
                id: `def_${startIdx + originalIndex}`
            }));

            shuffledPageData = shuffleArray(shuffledPageData);

            renderTerms(currentPageData);
            renderDefinitions(shuffledPageData);
            
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('results').innerHTML = '';
            document.getElementById('results').classList.remove('show');
        }

        function renderTerms(terms) {
            const container = document.getElementById('termsContainer');
            container.innerHTML = '';

            terms.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'item';
                div.dataset.term = item.term;
                div.innerHTML = `<strong>${item.term}</strong>`;
                
                if (matches[item.term]) {
                    div.classList.add('matched');
                    div.style.opacity = '0.5';
                } else {
                    div.addEventListener('click', () => selectTerm(item.term));
                    
                    if (selectedTerm === item.term) {
                        div.classList.add('selected');
                    }
                }
                
                container.appendChild(div);
            });
        }

        function renderDefinitions(definitions) {
            const container = document.getElementById('definitionsContainer');
            container.innerHTML = '';

            definitions.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'definition-item';
                div.dataset.correctTerm = item.correctTerm;
                div.dataset.defId = item.id;
                
                const matchedTerm = Object.keys(matches).find(term => matches[term] === item.id);
                
                if (matchedTerm) {
                    const termDiv = document.createElement('div');
                    termDiv.className = 'matched-term';
                    termDiv.innerHTML = `
                        ${matchedTerm}
                        <button class="disconnect-btn" onclick="disconnectMatch('${matchedTerm}')" title="Disconnect match">Ã—</button>
                    `;
                    
                    const defDiv = document.createElement('div');
                    defDiv.className = 'matched-definition';
                    defDiv.innerHTML = item.def;
                    
                    if (checkedAnswers && answerStates[matchedTerm] !== undefined) {
                        if (answerStates[matchedTerm]) {
                            termDiv.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
                            defDiv.style.borderColor = '#4CAF50';
                        } else {
                            termDiv.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
                            defDiv.style.borderColor = '#f44336';
                        }
                    }
                    
                    div.appendChild(termDiv);
                    div.appendChild(defDiv);
                } else {
                    div.className += ' item clickable';
                    div.innerHTML = item.def;
                    div.addEventListener('click', () => selectDefinition(item.id));
                    
                    if (selectedTerm) {
                        div.classList.add('can-match');
                    }
                }
                
                container.appendChild(div);
            });
        }

        function showInteractiveQuizControls(doShow) {
            document.getElementById('quizControls').style.display = doShow ? 'block' : 'none';
            document.getElementById('fillInControls').style.display = 'none';
        }

        function showQuizTypeControls(doShow){
            document.getElementById('quizTypeControls').style.display = doShow ? 'block' : 'none';
        }

        function selectTerm(term) {
            if (matches[term]) return;
            selectedTerm = selectedTerm === term ? null : term;
            renderTerms(currentPageData);
            renderDefinitions(shuffledPageData);
        }

        function updateCheckAnswersButton() {
            const allMatched = Object.keys(matches).length === currentPageData.length;
            const checkBtn = document.getElementById('checkAnswers');
            if (checkBtn) {
                checkBtn.disabled = !allMatched;
            }
        }

        function selectDefinition(defId) {
            if (!selectedTerm) {
                alert('Please select a term first!');
                return;
            }
            
            const existingMatch = Object.keys(matches).find(term => matches[term] === defId);
            if (existingMatch) {
                alert('This definition is already matched. Disconnect it first.');
                return;
            }
            
            if (matches[selectedTerm]) {
                delete matches[selectedTerm];
                delete answerStates[selectedTerm];
            }
            
            matches[selectedTerm] = defId;
            selectedTerm = null;
            
            renderTerms(currentPageData);
            renderDefinitions(shuffledPageData);
            updateCheckAnswersButton();
        }

        function disconnectMatch(term) {
            delete matches[term];
            delete answerStates[term];
            updateCheckAnswersButton();
            renderTerms(currentPageData);
            renderDefinitions(shuffledPageData);
        }

        function checkAnswers() {
            if (Object.keys(matches).length === 0) {
                alert('Please make some matches first!');
                return;
            }

            let correct = 0;
            let total = Object.keys(matches).length;

            Object.keys(matches).forEach(term => {
                const defId = matches[term];
                const defContainer = shuffledPageData.find(item => item.id === defId);
                if (!defContainer) return;
                
                const isCorrect = defContainer.allCorrectDefs && 
                    defContainer.allCorrectDefs.some(def => {
                        const correctTermForThisDef = currentPageData.find(item => 
                            item.allDefs && item.allDefs.includes(def)
                        );
                        return correctTermForThisDef && correctTermForThisDef.term === term;
                    });
                
                answerStates[term] = isCorrect;
                
                if (isCorrect) {
                    correct++;
                    if (!checkedAnswers) {
                        firstTryCorrect.add(term);
                    }
                }
            });

            if (!checkedAnswers) {
                totalAttempts += total;
                correctCount += correct;
            }

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <h3>Results for this page: ${correct}/${total} correct (${Math.round(correct/total*100)}%)</h3>
                <p>Green matches are correct, red matches are incorrect.</p>
                <p>You can disconnect and reconnect matches to fix errors, or move to the next page.</p>
                <p><em>Note: Terms may have multiple correct definitions - any valid match is accepted!</em></p>
            `;
            resultsDiv.classList.add('show');

            checkedAnswers = true;
            updateStats();
            updatePageControls();
            
            renderDefinitions(shuffledPageData);
        }

        function clearMatches() {
            matches = {};
            selectedTerm = null;
            answerStates = {};
            updateCheckAnswersButton();
            renderTerms(currentPageData);
            renderDefinitions(shuffledPageData);
            
            document.getElementById('results').innerHTML = '';
            document.getElementById('results').classList.remove('show');
        }

        function nextPage() {
            if (currentPage < totalPages) {
                clearMatches();
                currentPage++;
                shuffledPageData = [];
                answerStates = {};
                checkedAnswers = false;
                loadCurrentPage();
                updatePageControls();
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                shuffledPageData = [];
                answerStates = {};
                checkedAnswers = false;
                loadCurrentPage();
                updatePageControls();
            }
        }

        function updatePageControls() {
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.disabled = !checkedAnswers;
            nextBtn.style.display = currentPage < totalPages ? 'inline-block' : 'none';
        }

        function updateStats() {
            document.getElementById('currentPage').textContent = currentPage || fillInCurrentPage;
            document.getElementById('totalPages').textContent = totalPages || fillInTotalPages;
            document.getElementById('correctCount').textContent = firstTryCorrect.size || fillInFirstTryCorrect.size;
            document.getElementById('totalAttempts').textContent = Math.max(totalAttempts, firstTryCorrect.size) || Math.max(fillInTotalAttempts, fillInFirstTryCorrect.size);
            
            const attempts = totalAttempts || fillInTotalAttempts;
            const correct = firstTryCorrect.size || fillInFirstTryCorrect.size;
            const accuracy = attempts > 0 ? Math.round(correct / attempts * 100) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        // FILL-IN QUIZ FUNCTIONS
        function showFillInControls(doShow) {
            document.getElementById('fillInControls').style.display = doShow ? 'block' : 'none';
            document.getElementById('quizControls').style.display = 'none';
        }

        function startFillInQuiz() {
            const selectedSet = document.getElementById('quizSet').value;
            if (!selectedSet) {
                alert('Please select a quiz set first!');
                return;
            }

            document.getElementById('fillInControls').style.display = 'none';
            document.getElementById('quizTypeControls').style.display = 'none';
            document.getElementById('quizArea').classList.remove('active');
            document.getElementById('fillInArea').style.display = 'block';

            const rawData = quizSets[selectedSet];
            fillInQuizData = shuffleArray(rawData.map(item => ({
                term: item.term,
                def: getRandomDefinition(item.defs),
                allDefs: item.defs
            })));

            fillInItemsPerPage = parseInt(document.getElementById('fillInItemsPerPage').value);
            fillInTotalPages = Math.ceil(fillInQuizData.length / fillInItemsPerPage);
            fillInCurrentPage = 1;
            fillInAnswers = {};
            fillInChecked = false;
            fillInCorrectCount = 0;
            fillInTotalAttempts = 0;
            fillInFirstTryCorrect = new Set();

            loadFillInPage();
            updateStats();
            updateFillInPageControls();
        }

        function loadFillInPage() {
            const startIdx = (fillInCurrentPage - 1) * fillInItemsPerPage;
            const endIdx = startIdx + fillInItemsPerPage;
            fillInPageData = fillInQuizData.slice(startIdx, endIdx);

            renderFillInQuestions();
            
            document.getElementById('fillInPageInfo').textContent = `Page ${fillInCurrentPage} of ${fillInTotalPages}`;
            document.getElementById('fillInResults').innerHTML = '';
            document.getElementById('fillInResults').classList.remove('show');
        }

        function renderFillInQuestions() {
            const container = document.getElementById('fillInContainer');
            container.innerHTML = '';

            fillInPageData.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'fill-in-item';
                itemDiv.id = `fill-in-item-${index}`;

                const defDiv = document.createElement('div');
                defDiv.className = 'fill-in-definition';
                defDiv.innerHTML = `<span class="fill-in-number">${index + 1}</span>${item.def}`;

                const inputWrapper = document.createElement('div');
                inputWrapper.className = 'fill-in-input-wrapper';

                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'fill-in-input';
                input.placeholder = 'Type your answer here...';
                input.id = `fill-in-input-${index}`;
                input.dataset.correctTerm = item.term;
                
                // Restore previous answer if it exists
                if (fillInAnswers[index] !== undefined) {
                    input.value = fillInAnswers[index];
                }

                // Save answer on input
                input.addEventListener('input', (e) => {
                    fillInAnswers[index] = e.target.value;
                });

                // Allow Enter key to move to next input
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const nextInput = document.getElementById(`fill-in-input-${index + 1}`);
                        if (nextInput) {
                            nextInput.focus();
                        } else {
                            checkFillInAnswers();
                        }
                    }
                });

                inputWrapper.appendChild(input);

                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'fill-in-feedback';
                feedbackDiv.id = `fill-in-feedback-${index}`;
                feedbackDiv.style.display = 'none';

                itemDiv.appendChild(defDiv);
                itemDiv.appendChild(inputWrapper);
                itemDiv.appendChild(feedbackDiv);
                container.appendChild(itemDiv);
            });
        }

        function checkFillInAnswers() {
            let correct = 0;
            let total = fillInPageData.length;

            fillInPageData.forEach((item, index) => {
                const input = document.getElementById(`fill-in-input-${index}`);
                const feedback = document.getElementById(`fill-in-feedback-${index}`);
                const itemDiv = document.getElementById(`fill-in-item-${index}`);
                const userAnswer = (fillInAnswers[index] || '').trim().toLowerCase();
                const correctAnswer = item.term.toLowerCase();

                const isCorrect = userAnswer === correctAnswer;

                if (isCorrect) {
                    correct++;
                    if (!fillInChecked) {
                        fillInFirstTryCorrect.add(index);
                    }
                    input.classList.remove('incorrect');
                    input.classList.add('correct');
                    itemDiv.classList.remove('incorrect');
                    itemDiv.classList.add('correct');
                    feedback.className = 'fill-in-feedback correct';
                    feedback.innerHTML = 'âœ“ Correct!';
                    feedback.style.display = 'block';
                } else {
                    input.classList.remove('correct');
                    input.classList.add('incorrect');
                    itemDiv.classList.remove('correct');
                    itemDiv.classList.add('incorrect');
                    feedback.className = 'fill-in-feedback incorrect';
                    feedback.innerHTML = `âœ— Incorrect. The correct answer is: <strong>${item.term}</strong>`;
                    feedback.style.display = 'block';
                }
            });

            if (!fillInChecked) {
                fillInTotalAttempts += total;
                fillInCorrectCount += correct;
            }

            const resultsDiv = document.getElementById('fillInResults');
            resultsDiv.innerHTML = `
                <h3>Results for this page: ${correct}/${total} correct (${Math.round(correct/total*100)}%)</h3>
                <p>You can correct your answers and check again, or move to the next page.</p>
            `;
            resultsDiv.classList.add('show');

            fillInChecked = true;
            updateStats();
            updateFillInPageControls();
        }

        function clearFillInAnswers() {
            fillInAnswers = {};
            fillInPageData.forEach((item, index) => {
                const input = document.getElementById(`fill-in-input-${index}`);
                const feedback = document.getElementById(`fill-in-feedback-${index}`);
                const itemDiv = document.getElementById(`fill-in-item-${index}`);
                
                if (input) {
                    input.value = '';
                    input.classList.remove('correct', 'incorrect');
                }
                if (feedback) {
                    feedback.style.display = 'none';
                }
                if (itemDiv) {
                    itemDiv.classList.remove('correct', 'incorrect');
                }
            });
            
            document.getElementById('fillInResults').innerHTML = '';
            document.getElementById('fillInResults').classList.remove('show');
        }

        function nextFillInPage() {
            if (fillInCurrentPage < fillInTotalPages) {
                fillInCurrentPage++;
                fillInAnswers = {};
                fillInChecked = false;
                loadFillInPage();
                updateFillInPageControls();
            }
        }

        function updateFillInPageControls() {
            const nextBtn = document.getElementById('nextFillInBtn');
            nextBtn.disabled = !fillInChecked;
            nextBtn.style.display = fillInCurrentPage < fillInTotalPages ? 'inline-block' : 'none';
        }

        function resetQuiz() {
            document.getElementById('quizArea').classList.remove('active');
            document.getElementById('fillInArea').style.display = 'none';
            document.getElementById('quizSet').value = '';
            
            // Reset matching quiz
            currentQuizData = [];
            currentPageData = [];
            shuffledPageData = [];
            matches = {};
            selectedTerm = null;
            currentPage = 1;
            totalPages = 1;
            correctCount = 0;
            totalAttempts = 0;
            firstTryCorrect = new Set();
            answerStates = {};
            checkedAnswers = false;
            currentDefinitionChoices = {};
            
            // Reset fill-in quiz
            fillInQuizData = [];
            fillInPageData = [];
            fillInCurrentPage = 1;
            fillInTotalPages = 1;
            fillInAnswers = {};
            fillInChecked = false;
            fillInCorrectCount = 0;
            fillInTotalAttempts = 0;
            fillInFirstTryCorrect = new Set();
            
            updateStats();
            showInteractiveQuizControls(false);
            showFillInControls(false);
            showQuizTypeControls(false);
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function openPaperQuiz() {
            const quizSet = document.getElementById('quizSet').value;
            const rawTerms = quizSets[quizSet] || [];
            const terms = rawTerms.map(item => ({
                term: item.term,
                def: getRandomDefinition(item.defs)
            }));
            const termsParam = encodeURIComponent(JSON.stringify(terms));
            const quizURL = `paper_quiz.html?terms=${termsParam}&quizName=${quizSet}`;
            window.open(quizURL, '_blank');
        }    

        initializeApp();
    </script>
</body>
</html>
